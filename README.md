# Copyleft License Scanning Process



This document outlines the steps and script used to scan for copyleft licenses in a Node.js project using Python. It includes setup instructions, file organization, and an explanation of the analysis script `analyze_license.py`.



---




#### Setup and File Structure

1. **Dependencies Management:**

   - Ensure that the `package.json` and `package-lock.json` files, which define the dependencies of your Node.js application, are placed in a directory named `packages`.

2. **Analysis Script (`analyze_license.py`):**

   - This script is used to parse the results of a license scanning tool (which outputs a file named `output.json`) and check for any copyleft licenses.



#### Workflow

1. **Running the License Scan:**

   - Use a license scanning tool ([ScanCode toolkit](https://github.com/aboutcode-org/scancode-toolkit/)) to analyze your project for any licenses in the dependencies.

   - The scan outputs a JSON file named `output.json` containing information about the detected licenses.



2. **Analyzing the Output:**

   - The `analyze.py` script parses the `output.json` file to identify if any detected licenses match a list of known copyleft licenses.

   - If a copyleft license is detected, the script will print out details of the licenses and fail the pipeline by exiting with a non-zero status code.



---



### `analyze.py` Script Details



This script is designed to parse the `output.json` file and check for any copyleft licenses. Below is the script content:



```python

import json



# Define a list of copyleft licenses to flag

COPYLEFT_LICENSES = ["GPL", "AGPL", "LGPL", "Affero", "MPL", "EPL", "CC-BY-SA"]



# Load the ScanCode output

with open('output.json', 'r') as f:

    scan_data = json.load(f)



flagged_licenses = []



# Check for copyleft licenses in the detected licenses

for license_detection in scan_data.get('license_detections', []):

    for copyleft in COPYLEFT_LICENSES:

        if copyleft in license_detection['license_expression_spdx']:

            flagged_licenses.append(license_detection)



# Flag if any copyleft licenses are found

if flagged_licenses:

    print("Copyleft licenses detected! The following licenses were flagged:")

    for license in flagged_licenses:

        print(f"- {license['license_expression_spdx']} found in file {license['reference_matches'][0]['from_file']}")

    exit(1)  # Exit with error code to fail the pipeline

else:

    print("No copyleft licenses found.")

```



#### Explanation of the `analyze.py` Script:

- **COPYLEFT_LICENSES**: A list of known copyleft licenses that the script will flag if detected.

- **Loading the Output**: The script reads the `output.json` file generated by the license scanning tool.

- **License Detection**: It iterates through each license detected in the `output.json` file, checking if any of the detected licenses match a known copyleft license.

- **Flagging Copyleft Licenses**: 

  - If any matches are found, the script outputs the details (license type and file) and exits with a status code of `1` to indicate that a copyleft license was detected, thus failing the pipeline.

  - If no copyleft licenses are found, the script outputs a confirmation message and completes without error.



---



### Example Output

If copyleft licenses are detected, the output might look like this:

```

Copyleft licenses detected! The following licenses were flagged:

- GPL-3.0-or-later found in file /path/to/dependency

- AGPL-3.0-only found in file /path/to/another_dependency

```



If no copyleft licenses are detected, the output will be:

```

No copyleft licenses found.

```



---



### Notes

- **Exiting the Pipeline**: The script uses `exit(1)` to signal a failure when copyleft licenses are detected. This allows integration with CI/CD pipelines to automatically fail if undesired licenses are present.



---



This documentation provides a structured overview of your process for scanning copyleft licenses. It includes setup details, script explanation, and expected behavior for easy reference and implementation.
